name: Sonar Scan

on:
    workflow_call:
        inputs:
            project_key:
                required: true
                type: string
            scanner_type:
                required: true
                type: string
            run_tests:
                description: "Whether to run tests"
                type: boolean
                default: true
            test_settings_path:
                description: "Path to .runsettings file"
                type: string
                required: false
        secrets:
            SONAR_TOKEN:
                required: true
            SONAR_ORG:
                required: true

jobs:
    scan:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v4
            with:
                fetch-depth: 0

          - name: Setup .NET
            if: ${{ inputs.scanner_type == 'dotnet' }}
            uses: actions/setup-dotnet@v4
            with:
                dotnet-version: 10.0.x

          - name: Run Sonar .NET
            if: ${{ inputs.scanner_type == 'dotnet' }}
            env:
                GITHUB_TOKEN: ${{ github.token }}
                SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                SONAR_ORG: ${{ secrets.SONAR_ORG }}
            run: |
                ls -R
                dotnet tool install --global dotnet-sonarscanner
                dotnet-sonarscanner begin /k:"${{ inputs.project_key }}" \
                    /o:"${{ env.SONAR_ORG }}" \
                    /d:sonar.token="${{ env.SONAR_TOKEN }}" \
                    /d:sonar.host.url="https://sonarcloud.io" \
                    /d:sonar.cs.opencover.reportsPaths="**/coverage.opencover.xml" \
                    /d:sonar.projectBaseDir="$(pwd)" \
                    /d:sonar.exclusions="**/Program.cs"
                
                dotnet build --configuration Release /p:ContinuousIntegrationBuild=true /p:Deterministic=true
                
                if [ "${{ inputs.run_tests }}" = "true" ]; then
                    if [ -n "${{ inputs.test_settings_path }}" ]; then
                        echo "Running tests with settings: ${{ inputs.test_settings_path }}"
                        dotnet test --configuration Release --no-build \
                            --collect:"XPlat Code Coverage" \
                            --settings "${{ inputs.test_settings_path }}" \
                            /p:ContinuousIntegrationBuild=true \
                            /p:Deterministic=true \
                            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
                    else
                        echo "Running tests without settings"
                        dotnet test --configuration Release --no-build \
                            --collect:"XPlat Code Coverage" \
                            /p:ContinuousIntegrationBuild=true \
                            /p:Deterministic=true \
                            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
                    fi
                fi
                
                dotnet-sonarscanner end /d:sonar.token="${{ env.SONAR_TOKEN }}"

          - name: Run Sonar JS
            if: ${{ inputs.scanner_type == 'js' }}
            uses: sonarsource/sonarqube-scan-action@v6
            env:
                SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                SONAR_HOST_URL: "https://sonarcloud.io"
                SONAR_ORG: ${{ secrets.SONAR_ORG }}
            with:
                args: >
                    -Dsonar.projectKey=${{ inputs.project_key }}
                    -Dsonar.organization=${{ env.SONAR_ORG }}
